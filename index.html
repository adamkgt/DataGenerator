<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Generator danych testowych ‚Äî Freemium</title>
<meta name="description" content="Generator fikcyjnych danych do test√≥w manualnych. Dzia≈Ça lokalnie, bez backendu." />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
/* ... Tw√≥j CSS (bez zmian) ... */
</style>
</head>
<body data-theme="dark">
<div class="wrap">
  <header>
    <div class="title">
      <h1>Generator danych testowych ‚Äî Freemium</h1>
      <p>Fikcyjne dane do test√≥w manualnych. Dzia≈Ça lokalnie, bez backendu.</p>
    </div>
    <div class="toolbar">
      <span class="switch" title="Tryb jasny/ciemny">
        <span>Motyw</span>
        <input id="themeToggle" type="checkbox" />
      </span>
      <span class="switch" title="W≈ÇƒÖczone: u≈ºywa bezpiecznych domen e-mail, zakres√≥w telefon√≥w, nieprawdziwego PESEL">
        <span>Tryb bezpieczny</span>
        <input id="safeToggle" type="checkbox" checked />
      </span>
    </div>
  </header>

  <div class="grid">
    <section class="panel">
      <h3 style="margin:0 0 12px">Ustawienia</h3>

      <div class="checks" aria-label="Typy danych">
        <label class="check"><input type="checkbox" id="colName" checked /> <span>Imiƒô i nazwisko</span></label>
        <label class="check"><input type="checkbox" id="colEmail" checked /> <span>E-mail</span></label>
        <label class="check"><input type="checkbox" id="colPhone" checked /> <span>Telefon</span></label>
        <label class="check"><input type="checkbox" id="colPesel" checked /> <span>PESEL</span></label>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="field">
          <label for="count">Liczba rekord√≥w (max 50 w freemium)</label>
          <input id="count" type="number" min="1" max="50" value="10" />
        </div>
        <div class="field">
          <label for="locale">Lokalizacja (wp≈Çywa na imiona)</label>
          <select id="locale">
            <option value="pl">Polska (pl)</option>
            <option value="en">Angielski (en)</option>
            <option value="de">Niemiecki (de)</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="generate" class="btn primary">GENERUJ DANE</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="copyBtn" class="btn" title="Kopiuj ca≈ÇƒÖ tabelƒô do schowka">üìã Kopiuj</button>
        <button id="csvBtn" class="btn" title="Pobierz CSV">‚¨áÔ∏è Eksport CSV</button>
        <span class="hint">Freemium: bez zapisu historii, bez bazy, wszystko dzia≈Ça w przeglƒÖdarce.</span>
      </div>
    </section>

    <section class="tableWrap">
      <div class="tableHead">
        <div class="row">
          <strong>Wyniki</strong>
          <span id="rowsCount" class="badge">0 rekord√≥w</span>
        </div>
        <span class="hint">Kliknij nag≈Ç√≥wek, aby sortowaƒá</span>
      </div>
      <div style="overflow:auto; max-height: 60vh">
        <table id="dataTable" aria-live="polite">
          <thead id="thead"></thead>
          <tbody id="tbody"><tr><td class="empty" colspan="6">Brak danych. Wygeneruj rekordy.</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Faker UMD -->
<script src="https://cdn.jsdelivr.net/npm/@faker-js/faker@9.0.0/dist/faker.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  if (!window.faker) {
    console.error('Faker nie zosta≈Ç poprawnie za≈Çadowany!');
    return;
  }

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const toast = (msg) => {
    const el = $('#toast'); el.textContent = msg; el.style.display='block';
    setTimeout(()=> el.style.display='none', 1800);
  };

  const themeToggle = $('#themeToggle');
  const applyTheme = () => document.body.setAttribute('data-theme', themeToggle.checked ? 'light' : 'dark');
  themeToggle.addEventListener('change', applyTheme);
  applyTheme();

  const MAX_FREEMIUM = 50;
  const safeToggle = $('#safeToggle');

  const setLocale = (locale) => {
    switch(locale){
      case 'pl': window.faker.setDefaultRefDate(new Date()); window.faker.locale = 'pl'; break;
      case 'de': window.faker.locale = 'de'; break;
      default: window.faker.locale = 'en'; break;
    }
  };

  function genFullName() { return window.faker.person.fullName(); }
  function genEmail(fullName) {
    if (safeToggle.checked) {
      const parts = fullName.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').split(' ');
      const base = [parts[0]?.[0] || 'u', parts[1] || 'user'].join('.');
      const domains = ['example.com','example.org','example.net'];
      const domain = domains[Math.floor(Math.random()*domains.length)];
      return `${base.replace(/[^a-z0-9\.]/g,'')}${Math.floor(Math.random()*90+10)}@${domain}`;
    }
    return window.faker.internet.email();
  }

  function genPhonePL() {
    const block = safeToggle.checked ? Math.floor(Math.random()*200)+600 : Math.floor(Math.random()*900)+100;
    const rest = String(Math.floor(Math.random()*1_000_000)).padStart(6,'0');
    const raw = `${block}${rest}`;
    return raw.replace(/(\d{3})(\d{3})(\d{3})/,'$1 $2 $3');
  }

  function genPeselSafeInvalid() {
    const start = new Date(1970,0,1).getTime();
    const end   = new Date(2009,11,31).getTime();
    const d = new Date(start + Math.random()*(end-start));
    let year = d.getFullYear();
    let month = d.getMonth()+1;
    let day = d.getDate();
    let m = month + (year>=2000?20:0);
    const yy = String(year).slice(-2).padStart(2,'0');
    const mm = String(m).padStart(2,'0');
    const dd = String(day).padStart(2,'0');
    const serial = String(Math.floor(Math.random()*1000)).padStart(3,'0');
    const sex = Math.random()<0.5 ? 0 : 1;
    const base = `${yy}${mm}${dd}${serial}${sex}`;
    const weights = [1,3,7,9,1,3,7,9,1,3];
    const s = base.split('').reduce((acc,d,i)=> acc + parseInt(d,10)*weights[i], 0);
    const correct = (10 - (s % 10)) % 10;
    const bad = (correct + 1) % 10;
    return base + bad;
  }

  function genPeselValid() {
    const start = new Date(1970,0,1).getTime();
    const end   = new Date(2009,11,31).getTime();
    const d = new Date(start + Math.random()*(end-start));
    let year = d.getFullYear();
    let month = d.getMonth()+1;
    let day = d.getDate();
    let m = month + (year>=2000?20:0);
    const yy = String(year).slice(-2).padStart(2,'0');
    const mm = String(m).padStart(2,'0');
    const dd = String(day).padStart(2,'0');
    const serial = String(Math.floor(Math.random()*1000)).padStart(3,'0');
    const sex = Math.random()<0.5 ? 0 : 1;
    const base = `${yy}${mm}${dd}${serial}${sex}`;
    const weights = [1,3,7,9,1,3,7,9,1,3];
    const s = base.split('').reduce((acc,d,i)=> acc + parseInt(d,10)*weights[i], 0);
    const control = (10 - (s % 10)) % 10;
    return base + control;
  }

  const thead = $('#thead');
  const tbody = $('#tbody');
  const rowsCount = $('#rowsCount');

  let data = [];
  let sortState = { key:null, dir:1 };

  function renderTable(columns, rows){
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    columns.forEach(col=>{
      const th = document.createElement('th');
      th.textContent = col.label;
      th.dataset.key = col.key;
      th.addEventListener('click', ()=> toggleSort(col.key));
      tr.appendChild(th);
    });
    thead.appendChild(tr);

    tbody.innerHTML = '';
    if(!rows.length){
      const tr = document.createElement('tr'); const td = document.createElement('td');
      td.colSpan = columns.length; td.className='empty'; td.textContent='Brak danych. Wygeneruj rekordy.';
      tr.appendChild(td); tbody.appendChild(tr);
    } else {
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        columns.forEach(c=>{
          const td = document.createElement('td');
          td.textContent = r[c.key] ?? '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
    rowsCount.textContent = `${rows.length} rekord√≥w`;
  }

  function toggleSort(key){
    if(sortState.key === key){ sortState.dir *= -1; }
    else { sortState.key = key; sortState.dir = 1; }
    data.sort((a,b)=>{
      const va = String(a[key] ?? '').toLowerCase();
      const vb = String(b[key] ?? '').toLowerCase();
      if(va<vb) return -1*sortState.dir;
      if(va>vb) return  1*sortState.dir;
      return 0;
    });
    renderTable(currentColumns(), data);
  }

  function currentColumns(){
    const cols = [];
    if($('#colName').checked)  cols.push({key:'name',  label:'Imiƒô i nazwisko'});
    if($('#colEmail').checked) cols.push({key:'email', label:'E-mail'});
    if($('#colPhone').checked) cols.push({key:'phone', label:'Telefon'});
    if($('#colPesel').checked) cols.push({key:'pesel', label:'PESEL'});
    return cols.length ? cols : [{key:'name',label:'Imiƒô i nazwisko'}];
  }

  $('#generate').addEventListener('click', ()=>{
    const n = Math.min(parseInt($('#count').value || '0',10), MAX_FREEMIUM);
    $('#count').value = String(n || 0);
    if(!n){ toast('Podaj liczbƒô rekord√≥w (1‚Äì50).'); return; }

    setLocale($('#locale').value);
    const cols = currentColumns();
    data = [];

    for(let i=0;i<n;i++){
      const name = genFullName();
      const row = {};
      cols.forEach(c=>{
        if(c.key==='name')  row.name  = name;
        if(c.key==='email') row.email = genEmail(name);
        if(c.key==='phone') row.phone = genPhonePL();
        if(c.key==='pesel') row.pesel = safeToggle.checked ? genPeselSafeInvalid() : genPeselValid();
      });
      data.push(row);
    }
    sortState = {key:null, dir:1};
    renderTable(cols, data);
    toast(`Wygenerowano ${n} rekord√≥w`);
  });

  $('#copyBtn').addEventListener('click', async ()=>{
    if(!data.length){ toast('Brak danych do skopiowania.'); return; }
    const cols = currentColumns();
    const header = cols.map(c=>c.label).join('\t');
    const lines = data.map(r=> cols.map(c=> r[c.key] ?? '').join('\t'));
    const text = [header,...lines].join('\n');
    await navigator.clipboard.writeText(text);
    toast('Skopiowano do schowka');
  });

  $('#csvBtn').addEventListener('click', ()=>{
    if(!data.length){ toast('Brak danych do eksportu.'); return; }
    const cols = currentColumns();
    const header = cols.map(c=>`"${c.label}"`).join(',');
    const lines = data.map(r=> cols.map(c=> `${String(r[c.key]??'').replace(/"/g,'""')}`).join(','));
    const csv = [header, ...lines].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'dane_testowe.csv'; a.click();
    URL.revokeObjectURL(url);
  });
});
</script>
</body>
</html>
